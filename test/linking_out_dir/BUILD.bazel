"""Tests that cargo build scripts can create archives in OUT_DIR and link to
them. This requires that binaries or shared libraries include the out dirs of
transitive dependencies when linking."""

load("//cargo:defs.bzl", "cargo_build_script")
load("//rust:defs.bzl", "rust_library", "rust_binary")
load("@bazel_skylib//rules:native_binary.bzl", "native_test")

cc_library(
    name = "foo",
    srcs = ["foo.c"],
)

filegroup(
    name = "foo_static",
    srcs = [":foo"],
    output_group = "archive",
)

cargo_build_script(
    name = "build_script",
    crate_root = "build.rs",
    data = [":foo_static"],
    srcs = ["build.rs"],
    build_script_env = { "ARCHIVE_PATH": "$(execpath :foo_static)" },
)

rust_library(
    name = "bar",
    srcs = ["bar.rs"],
    deps = [":build_script"],
)

rust_binary(
    name = "main",
    srcs = ["main.rs"],
    deps = [":bar"],
)

native_test(
    name = "test",
    src = ":main",
)
